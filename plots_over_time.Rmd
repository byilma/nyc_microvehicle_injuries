---
title: "Bike use and bike and microvehicles crashes over time"
date: 
output: 
  html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(httr)
library(purrr)
library(plotly)
library(patchwork)

options(scipen=999)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

"Filter For" function:
```{r filter functions, include = FALSE}

filter_for = function(dataset, type) {
  if (type == "micro") {
  dataset %>% filter(str_detect(vehicle_options, "[Bb]ike") | 
           str_detect(vehicle_options, "REVEL") | 
           str_detect(vehicle_options, "SCO")  |
           str_detect(vehicle_options, "MOP")   |
           str_detect(vehicle_options, "ELEC")  |
           str_detect(vehicle_options, "^E-")) %>% 
  filter(vehicle_options != "ESCOVATOR" & vehicle_options != "Bike" &
      str_detect(vehicle_options, "Dirt", negate = TRUE),
      str_detect(vehicle_options, "[Mm]otorbike", negate = TRUE)
           )
}

  else if (type == "bike") {
  dataset %>% filter(str_starts(vehicle_options, "[Bb]ike")) 
  }
}
```

Load bike_crash_agg df
```{r}
bike_crash_agg = 
  read_csv("./data/crash_dat.csv") %>%
  filter_for("bike") %>% 
  group_by(date) %>% 
  summarize(daily_bikes_crashed = n())

# This will give us the daily total of bikes that were involved in crashes, rather
# than the daily total of crashes that involved bikes. ie, if there was one crash 
# involving two bikes, that will count as two. (as explained in first version in import file)
```

Load microvehicle crashed df 
```{r}
microvehicle_crash_agg = 
  read_csv("./data/crash_dat.csv") %>%
  filter_for("micro") %>% 
  group_by(date) %>% 
  summarize(daily_microveh_crashed = n()) 

# This will give us the daily total of microvehicles that were involved in crashes, rather
# than the daily total of crashes that involved microvehicles. ie, if there was one crash 
# involving two bikes, that will count as two. (as explained in first version in import file)
```

Load bike count data
```{r}
bike_count_agg = 
  read_csv("./data/bike_count_df.csv")
```

## Visualization option 1:

One way of visualizing: 2017-2020 Bike use, bikes involved in crashes, microvehicles involved in crashes. I thought it would be valuable to go back to 2017 to get a sense of non-covid bike use to compare to 2020.

This will need to have an aspect ratio tall enough to show all three clearly.

```{r}
microveh_crash_plot = microvehicle_crash_agg %>% 
  ggplot(aes(x = date, y = daily_microveh_crashed)) +
  geom_point(alpha = .3) +
  geom_smooth(se = FALSE) +
  labs(
    title = "Microvehicles involved in crashes in NYC daily: 2017-2020",
    x = "Date",
    y = ""
  )

bike_crash_plot = bike_crash_agg %>% 
  ggplot(aes(x = date, y = daily_bikes_crashed)) +
  geom_point(alpha = .3) +
  geom_smooth(se = FALSE) +
  labs(
    title = "Bicycles involved in crashes in NYC daily: 2017-2020",
    x = "Date",
    y = ""
  )
  
bike_count_plot = bike_count_agg %>%
  ggplot(aes(x = date, y = total_daily_bikes)) +
  geom_point(alpha = .3) +
  geom_smooth(se = FALSE) +
  labs(
    title = "Bicycle use in NYC: Bicycles counted daily by NYC DOT 2017-2020",
    x = "Date",
    y = ""
  )

bike_count_plot / bike_crash_plot / microveh_crash_plot
```

## Visualization option 2: Overlay years for bike use, overlay years for bike crashes

**Still to do for both plots: change x-axis labels, Adjust colors so 2020 isn't yellow...**

Plotly plot of daily bike counts. 
```{r}
bike_count_agg = bike_count_agg %>% 
  mutate(year = lubridate::year(date),
         month = lubridate::month(date),
         day_of_month = lubridate::mday(date), 
         day_of_year = lubridate::yday(date),
         common_date = lubridate::mdy(paste(month, day_of_month, "2020")))
  
bike_count_yr_plot = bike_count_agg %>%  
  ggplot(aes(x = day_of_year, y = total_daily_bikes, 
             group = year, color = as.factor(year))) +
  geom_point(alpha = .3) +
  geom_smooth(se = FALSE) + 
  labs(
    title = "Bicycles counted daily by NYC DOT 2017-2020",
    x = "Month and Day",
    y = "Number of Collisions"
    ) +
  theme(text = element_text(size = 15), 
        axis.text.x = element_text(angle = 60, hjust=1, size=10)) +
  scale_colour_discrete("Year") +
  scale_x_date(labels = lubridate::month(bike_count_agg$date))
  
  

ggplotly(bike_count_yr_plot)
```

Analagous plot of bikes involved in crashes:
```{r}
bike_crash_yr_plot = bike_crash_agg %>% 
    mutate(year = lubridate::year(date),
         month = lubridate::month(date),
         day_of_year = lubridate::yday(date)) %>% 
  ggplot(aes(x = day_of_year, y = daily_bikes_crashed, 
             group = year, color = as.factor(year))) +
  geom_point(alpha = .3) +
  geom_smooth(se = FALSE) + 
  labs(
    title = "Bicycles involved in crashes daily in NYC 2017-2020",
    x = "Month and Day",
    y = "Bikes involved in crashes"
    ) +
  theme(text = element_text(size = 15), 
        axis.text.x = element_text(angle = 60, hjust=1, size=10)) +
  scale_colour_discrete("Year")

ggplotly(bike_crash_yr_plot)
```

Notes: bicycle use in 2020 seems comparable, and at some points slightly higher than bike use in previous years. However, bicycle crashes were lower than in previous years. It's hard to know if this is due to an improvement in bicycle safety in general or if reduced car traffic during covid had an impact.

Crashes per observed bike:


Analagous plot to those above looking at crashes PER observed bike. 

```{r}
bike_count_and_crash = 
  inner_join(
    bike_count_agg,
    bike_crash_agg,
    by = "date"
  ) %>% 
  mutate(crashes_per_bike = daily_bikes_crashed/total_daily_bikes)

bike_count_and_crash %>% 
    mutate(year = lubridate::year(date),
         month = lubridate::month(date),
         day_of_year = lubridate::yday(date)) %>% 
  ggplot(aes(x = day_of_year, y = crashes_per_bike, 
             group = year, color = as.factor(year))) +
  geom_point(alpha = .3) +
  geom_smooth(se = FALSE) + 
  labs(
    title = "Crashes per counted bike daily in NYC 2017-2020",
    x = "Month and Day",
    y = "Bikes involved in crashes"
    ) +
  theme(text = element_text(size = 15), 
        axis.text.x = element_text(angle = 60, hjust=1, size=10)) +
  scale_colour_discrete("Year")
```

