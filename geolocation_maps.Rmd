---
title: "Geolocation and Maps"
date: "11/30/2020"
output: 
  html_document:
    toc: true
    always_allow_html: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(httr)
library(plotly)
library(readr)
library(knitr)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d

# setting user, api key and access token
Sys.setenv("plotly_username"="aabramov90")

Sys.setenv("plotly_api_key"="TcaNTrLIJVEJyrUlhXgd")

Sys.setenv('MAPBOX_TOKEN' = 'pk.eyJ1IjoiYWFicmFtb3Y5MCIsImEiOiJja2k5aHQ4ZWswZnhmMnNtcDJ0b2FlZzdjIn0.QcpV6ynhO9mlLga7CvUJwA')

```

Data Import
```{r, import}
crash_dat = read_csv("./data/crash_dat.csv")

microvehicles = 
  crash_dat %>% 
  drop_na(c(latitude, longitude, borough)) %>% 
  filter(
    year > 2018,
    latitude > 0) %>%  
  filter(str_detect(vehicle_options, "[Bb]ike") | 
           str_detect(vehicle_options, "REVEL") | 
           str_detect(vehicle_options, "SCO")  |
           str_detect(vehicle_options, "MOP")   |
           str_detect(vehicle_options, "ELEC")  |
           str_detect(vehicle_options, "^E-")) %>% 
  filter(vehicle_options != "ESCOVATOR",
      str_detect(vehicle_options, "Dirt", negate = TRUE),
      str_detect(vehicle_options, "[Mm]otorbike", negate = TRUE)) 
```

# Visualizations: Maps

## Location Data

This is my initial thought on how this map might look.  

I could change the size of the marker based on # people injured, or the color of the marker based on # people injured.

## Crashes with Cyclist Injuries by Borough  / Pre-Post Covid

```{r}
map_cyclists_injured=  microvehicles %>% 
  filter(
    str_detect(vehicle_options, "[Bb]ike"),
    number_of_cyclist_injured > 0) %>%
  mutate(
    covid = as.factor(if_else(year == 2019, 'Pre-COVID', 'COVID')),
    text_label = str_c("Crash Time: ", covid)) %>% 
  plot_mapbox(
    lon = ~longitude, 
    lat = ~latitude, 
    split = ~borough, 
    color = ~covid,
    mode = 'markers',
    text = ~text_label) %>% 
  layout(
    mapbox = 
      list(
        style = 'dark',
        zoom = 9.5, 
           center = list(lat = 40.71, lon = -73.97)),
    title = "Cyclist Injuries in NYC \nPre and Post Covid")

map_cyclists_injured %>% config(mapboxAccessToken = Sys.getenv("MAPBOX_TOKEN"))
```

Microvehicles with People Injured

```{r}
crash_map_microvehicles = 
  microvehicles %>% 
  filter(
    number_of_persons_injured > 0)   %>%
  mutate(
    covid = as.factor(if_else(year == 2019, 'Pre-COVID', 'COVID')),
    text_label = 
      str_c("Time Period: ", covid)) %>% 
  plot_mapbox(
    x = ~longitude, 
    y = ~latitude) %>% 
  add_polygons(
    color = ~borough,
    text = ~text_label) %>% 
  layout(
    mapbox = 
           list(
             style = "light",
             zoom = 9.5, 
             center = list(lat = 40.71, lon = -73.97)),
    title = "Microvehicle Injuries in NYC \nPre and Post Covid")

crash_map_microvehicles
```


## Density

Playing around with the plot_ly density functions.  
Here are the areas most prone to bicycle accidents with cyclists injured.

### Density of Bicycle Crashes with Cyclists Injured During Covid

```{r}
crash_map_bike_density_covid = 
  microvehicles %>% 
  filter(
    str_detect(vehicle_options, "[Bb]ike"),
    number_of_cyclist_injured > 0) %>% 
  mutate(
    covid = as.factor(if_else(year == 2019, 'Pre-COVID', 'COVID')),
    text_label = str_c("Time Period: ", covid))  %>% 
  filter(
    covid == "COVID"
  ) %>% 
  plot_ly(
    lon = ~longitude, 
    lat = ~latitude,  
    type = 'densitymapbox',
    radius = 3,
    text = ~covid,
    hoverinfo = 'text') %>% 
  layout(
    mapbox = 
      list(
        style = 'open-street-map',
        zoom = 9.5,
        center = list(lat = 40.71, lon = -73.97)),
      title = "Density of Bicycle Crashes \n During Covid in NYC")

crash_map_bike_density_covid
```

### Density of Bicycle Crashes with Cyclists Injured Prior to Covid

```{r}
crash_map_bike_density_precovid = 
  crash_dat %>% 
  filter(
    str_detect(vehicle_options, "[Bb]ike"),
    number_of_cyclist_injured > 0) %>% 
  mutate(
    covid = as.factor(if_else(year == 2019, 'Pre-COVID', 'COVID')),
    text_label = str_c("Time Period: ", covid))  %>% 
  filter(covid == "Pre-COVID") %>% 
  plot_ly(
    lon = ~longitude, 
    lat = ~latitude,  
    type = 'densitymapbox',
    radius = 3,
    text = ~covid,
    hoverinfo = 'text') %>% 
  layout(
    mapbox = 
      list(
        style = 'open-street-map',
        zoom = 9.5,
        center = list(lat = 40.71, lon = -73.97)),
      title = "Density of Bicycle Crashes \n Prior to Covid in NYC")

crash_map_bike_density_precovid

```


```{r}
map_test =
  microvehicles %>% 
  plot_ly(
    x = ~longitude, 
    y = ~latitude, 
    type   = 'scattermapbox', 
    mode   = 'markers') %>% 
  layout(
    mapbox = 
      list(style = 'dark', 
           zoom = 9.5, 
           center = list(lat = 40.71, lon = -73.97)),
    title = "Cyclist Injuries in NYC \nPre and Post Covid")

map_test %>% config(mapboxAccessToken = Sys.getenv("MAPBOX_TOKEN"))
```

