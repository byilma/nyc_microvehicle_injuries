---
title: "Geolocation and Maps"
date: "11/30/2020"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(plotly)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d

Sys.setenv('MAPBOX_TOKEN' = 'pk.eyJ1IjoiYWFicmFtb3Y5MCIsImEiOiJja2k4OWpmNWcwM2puMnhzOGhoOTl0ZzJhIn0.1DdYryz7XmehjnULYi6Hew')
```

Data Import
```{r}
crash_dat = read_csv("./data/crash_dat.csv")


#the code below is not just filtering for microvehicles, it also includes "bikes" ... consider using the `filter_for` function
#why do we drop_na "borough", we lose about 7,000 obs when we drop_na(borough) - wonder if there's a way to figure out the "NA"-boroughs based on latitude & longitude info
microvehicles = 
  crash_dat %>% 
  drop_na(c(latitude, longitude, borough)) %>% 
  filter(latitude > 0) %>% 
  filter(str_detect(vehicle_options, "[Bb]ike") | 
           str_detect(vehicle_options, "REVEL") | 
           str_detect(vehicle_options, "SCO")  |
           str_detect(vehicle_options, "MOP")   |
           str_detect(vehicle_options, "ELEC")  |
           str_detect(vehicle_options, "^E-")) %>% 
  filter(vehicle_options != "ESCOVATOR",
      str_detect(vehicle_options, "Dirt", negate = TRUE),
      str_detect(vehicle_options, "[Mm]otorbike", negate = TRUE)) 
```

# Visualizations: Maps

## Location Data

This is my initial thought on how this map might look.  

I could change the size of the marker based on # people injured, or the color of the marker based on # people injured.

## Crashes with Cyclist Injuries by Borough  / Pre-Post Covid

```{r}
microvehicles %>% 
  filter(
    str_detect(vehicle_options, "[Bb]ike"),
    number_of_cyclist_injured > 0) %>%
  mutate(
    covid = as.factor(if_else(year == 2019, 'Pre-COVID', 'COVID')),
    text_label = str_c("Crash Time: ", covid)) %>% 
  plot_mapbox(
    x = ~longitude, 
    y = ~latitude,  
    mode = 'scattermapbox',
    color = ~covid,
    text = ~text_label) %>% 
  layout(
    mapbox = 
      list(
        style = "dark", zoom = 9.5,
        center = list(lat = 40.71, lon = -73.97)),
    title = "Cyclist Injuries in NYC \nPre and Post Covid")
```

Microvehicles with People Injured

```{r}
crash_map_microvehicles = 
  microvehicles %>% 
  filter(
    number_of_persons_injured > 0)   %>%
  mutate(
    covid = as.factor(if_else(year == 2019, 'Pre-COVID', 'COVID')),
    text_label = 
      str_c("Time Period: ", covid)) %>% 
  plot_mapbox(
    x = ~longitude, 
    y = ~latitude,  
    color = ~borough,
    text = ~text_label) %>% 
  layout(
    mapbox = 
           list(
             style = "light",
             zoom = 9.5, 
             center = list(lat = 40.71, lon = -73.97)),
    title = "Microvehicle Injuries in NYC \nPre and Post Covid")

crash_map_microvehicles
```


## Density

Playing around with the plot_ly density functions.  
Here are the areas most prone to bicycle accidents with cyclists injured.

### Density of Bicycle Crashes with Cyclists Injured During Covid

```{r}
crash_map_bike_density_covid = 
  microvehicles %>% 
  filter(
    str_detect(vehicle_options, "[Bb]ike"),
    number_of_cyclist_injured > 0) %>% 
  mutate(
    covid = as.factor(if_else(year == 2019, 'Pre-COVID', 'COVID')),
    text_label = str_c("Time Period: ", covid))  %>% 
  filter(
    covid == "COVID"
  ) %>% 
  plot_ly(
    lon = ~longitude, 
    lat = ~latitude,  
    type = 'densitymapbox',
    radius = 3,
    text = ~covid,
    hoverinfo = 'text') %>% 
  layout(
    mapbox = 
      list(
        style = 'open-street-map',
        zoom = 9.5,
        center = list(lat = 40.71, lon = -73.97)),
      title = "Density of Bicycle Crashes \n During Covid in NYC")

crash_map_bike_density_covid
```

### Density of Bicycle Crashes with Cyclists Injured Prior to Covid

```{r}
crash_map_bike_density_precovid = 
  crash_dat %>% 
  filter(
    str_detect(vehicle_options, "[Bb]ike"),
    number_of_cyclist_injured > 0) %>% 
  mutate(
    covid = as.factor(if_else(year == 2019, 'Pre-COVID', 'COVID')),
    text_label = str_c("Time Period: ", covid))  %>% 
  filter(covid == "Pre-COVID") %>% 
  plot_ly(
    lon = ~longitude, 
    lat = ~latitude,  
    type = 'densitymapbox',
    radius = 3,
    text = ~covid,
    hoverinfo = 'text') %>% 
  layout(
    mapbox = 
      list(
        style = 'open-street-map',
        zoom = 9.5,
        center = list(lat = 40.71, lon = -73.97)),
      title = "Density of Bicycle Crashes \n Prior to Covid in NYC")

crash_map_bike_density_precovid

```

