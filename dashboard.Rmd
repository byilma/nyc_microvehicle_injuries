---
title: "Microvehicles & Bike Incidents in NYC"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    source_code: embed
---

```{r setup, include=FALSE}
library(tidyverse)
library(httr)
library(purrr)
library(leaflet)
library(plotly)
library(flexdashboard)


knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d

Sys.setenv('MAPBOX_TOKEN' = 'pk.eyJ1IjoiYWFicmFtb3Y5MCIsImEiOiJja2gyZm5obzQwNWIxMnFxc3phcWh1MWtwIn0.amAvJHtFkTl9XWJ68fh96Q')
```


```{r, include = F}
#Import
crash_dat = read_csv("./data/crash_dat.csv")

#Create month_df
month_df=
  tibble(
    month = 1:12,
    month_name = factor(month.name, ordered = TRUE, levels = month.name)
  )
```


```{r, include = FALSE}
filter_for = function(dataset, type) {
  if (type == "micro") {
  dataset %>% filter(str_detect(vehicle_options, "[Bb]ike") | 
           str_detect(vehicle_options, "REVEL") | 
           str_detect(vehicle_options, "SCO")  |
           str_detect(vehicle_options, "MOP")   |
           str_detect(vehicle_options, "ELEC")  |
           str_detect(vehicle_options, "^E-")) %>% 
  filter(vehicle_options != "ESCOVATOR" & vehicle_options != "Bike" &
      str_detect(vehicle_options, "Dirt", negate = TRUE),
      str_detect(vehicle_options, "[Mm]otorbike", negate = TRUE)
           )
}

  else if (type == "bike") {
  dataset %>% filter(str_starts(vehicle_options, "[Bb]ike")) 
  }
}
```

Interactive Maps
=======================================================================

Column {.tabset data-width=400}
-----------------------------------------------------------------------

### Bike Crash site in NYC, 2017 - 2020

```{r, echo=FALSE}
crash_map_boro = 
  crash_dat %>% 
  drop_na(c(latitude, longitude, borough)) %>% 
  filter(str_detect(vehicle_options, "[Bb]ike"))  %>% 
  filter(number_of_cyclist_injured > 0) %>% 
  mutate(
    text_label = str_c("Crash Time: ", crash_time, "\nNumber of Persons Injured: ", number_of_persons_injured)) %>% 
  plot_mapbox(
    x = ~longitude, 
    y = ~latitude,  
    mode = 'scattermapbox', 
    split = ~borough,
    size = ~number_of_persons_injured,
    color = ~borough,
    text = ~text_label,
    hoverinfo = "text") %>% 
  layout(
    mapbox = 
      list(
        style = "dark",
        zoom = 9.5,
        center = list(lat = 40.71, lon = -73.97)))



crash_map_boro %>% 
  layout(
    title = "Bicycle Crashes with Injuries in New York City (2019-2020)") #looking 2017-2020 instead
```

### Density Plot of Bike Crashes Fit

```{r, echo=FALSE}
crash_map_density = 
  crash_dat %>% 
  drop_na(c(latitude, longitude)) %>% 
  filter(str_detect(vehicle_options, "[Bb]ike"))  %>% 
  filter(number_of_cyclist_injured > 0) %>% 
  mutate(
    text_label = str_c("Crash Time: ", crash_time, "\nNumber of Persons Injured: ", number_of_persons_injured)) %>% 
  plot_ly(
    lon = ~longitude, 
    lat = ~latitude,  
    type = 'densitymapbox',
    symbol = 'square',
    radius = 3) %>% 
  layout(
    mapbox = list(
      style = 'open-street-map',
      zoom = 9.5,
      center = list(lat = 40.71, lon = -73.97)))

crash_map_density %>% 
  layout(
    style = 'open-street-map',
    title = "Density of Bicycle Crashes with Injuries in New York City in 2019") %>% 
  colorbar(title = "Density of Bicycle Crashes")
```

Incidents over Time
=======================================================================

Row
-----------------------------------------------------------------------

### Title 1

```{r}

```

### Title 2

```{r}

```

Row
-----------------------------------------------------------------------

### Title 3

```{r}

```

### Title 4

```{r}

```
   
   
Contributing Factors
=======================================================================

Row
-----------------------------------------------------------------------

###  Title 1

```{r}

```


###  Title 2

```{r}

```

Row
-----------------------------------------------------------------------

###  Title 3

```{r}

```

### Title 4

```{r}

```


   
   
Statistical Models
=======================================================================

Column {.tabset data-width=650}
-----------------------------------------------------------------------

### Possion Regression On Bike-Injuries

```{r, echo = FALSE, fig.width=9, fig.height=7}

crash_dat%>%
  filter_for("bike") %>% 
  filter(year %in% c(2019, 2020)) %>%
  group_by(year) %>%
  mutate(year_2020 = year - 2019) %>%
  nest(data = -month) %>%
  mutate(models = map(data, ~glm(number_of_persons_injured ~ year_2020:borough,
                                 family = "poisson", data = .x)),
         models = map(models, broom::tidy)) %>% 
  select(-data) %>% 
  unnest(models) %>%
  select(month, term, estimate, std.error, p.value) %>% 
  mutate(term = str_replace(term, "year_2020:borough", "2020 v. 2019, Borough: ")) %>%
  left_join(month_df, by = "month") %>%
  select(-month) %>%
  rename(month = month_name) %>%
  select(month, everything()) %>% 
  filter(term != "(Intercept)" & month != "November" & month != "December") %>%
  mutate(term = str_replace(term, "2020 v. 2019, ", "")) %>%
  ggplot(aes(x = month, y = exp(estimate), color = term)) + 
  geom_point(show.legend = FALSE, aes(size = estimate, alpha = .7)) +
  geom_errorbar(aes(ymin = exp(estimate - (1.96*std.error)), 
                    ymax = exp(estimate + (1.96*std.error)))) +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "darkred", size = 1, alpha = .7) +
  labs(
    title = "Difference in Rate of Injuries Per Crash Involving a Bike in 2020 v. 2019",
    x = "Month",
    y = "2020 v. 2019 Difference"
  ) +
  ylim(0, 5) +
  theme(legend.title = element_blank(),
        text = element_text(size = 10),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) + 
  facet_grid(. ~ term)


```

### Possion Regression On Microvehicle-Injuries

```{r, echo = FALSE, fig.width=9, fig.height=7}
crash_dat %>%
  filter_for("micro") %>% 
  filter(year %in% c(2019, 2020)) %>%
  group_by(year) %>%
  mutate(year_2020 = year - 2019) %>%
  nest(data = -month) %>%
  mutate(models = map(data, ~glm(number_of_persons_injured ~ year_2020:borough,
                                 family = "poisson", data = .x)),
         models = map(models, broom::tidy)) %>% 
  select(-data) %>% 
  unnest(models) %>%
  select(month, term, estimate, std.error, p.value) %>% 
  mutate(term = str_replace(term, "year_2020:borough", "2020 v. 2019, Borough: ")) %>%
  left_join(month_df, by = "month") %>%
  select(-month) %>%
  rename(month = month_name) %>%
  select(month, everything()) %>% 
  filter(term != "(Intercept)" & month != "November" & month != "December") %>%
  mutate(term = str_replace(term, "2020 v. 2019, ", "")) %>%
  ggplot(aes(x = month, y = exp(estimate), color = term)) + 
  geom_point(show.legend = FALSE, aes(size = estimate, alpha = .7)) +
  geom_errorbar(aes(ymin = exp(estimate - (1.96*std.error)), 
                    ymax = exp(estimate + (1.96*std.error)))) +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "darkred", size = 1, alpha = .7) +
  labs(
    title = "Difference in Rate of Injuries Per Crash Involving a Microvehicle in 2020 v. 2019",
    x = "Month",
    y = "2020 v. 2019 Difference"
  ) +
  ylim(0, 5) +
  theme(legend.title = element_blank(),
        text = element_text(size = 10),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) + 
  facet_grid(. ~ term)
```

