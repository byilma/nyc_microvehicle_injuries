---
title: "Microvehicles & Bike Incidents in NYC"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    source_code: embed
    always_allow_html: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(httr)
library(purrr)
library(leaflet)
library(plotly)
library(flexdashboard)


knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d

# setting user, api key and access token
Sys.setenv("plotly_username"="aabramov90")

Sys.setenv("plotly_api_key"="TcaNTrLIJVEJyrUlhXgd")

Sys.setenv('MAPBOX_TOKEN' = 'pk.eyJ1IjoiYWFicmFtb3Y5MCIsImEiOiJja2k5aHQ4ZWswZnhmMnNtcDJ0b2FlZzdjIn0.QcpV6ynhO9mlLga7CvUJwA')
```


```{r, include = FALSE}
filter_for = function(dataset, type) {
  if (type == "micro") {
  dataset %>% filter(str_detect(vehicle_options, "[Bb]ike") | 
           str_detect(vehicle_options, "REVEL") | 
           str_detect(vehicle_options, "SCO")  |
           str_detect(vehicle_options, "MOP")   |
           str_detect(vehicle_options, "ELEC")  |
           str_detect(vehicle_options, "^E-")) %>% 
  filter(vehicle_options != "ESCOVATOR" & vehicle_options != "Bike" &
      str_detect(vehicle_options, "Dirt", negate = TRUE),
      str_detect(vehicle_options, "[Mm]otorbike", negate = TRUE)
           )
}

  else if (type == "bike") {
  dataset %>% filter(str_starts(vehicle_options, "[Bb]ike")) 
  }
}
```


```{r, include = F}
#Import
crash_dat = read_csv("./data/crash_dat.csv")

#Create month_df
month_df=
  tibble(
    month = 1:12,
    month_name = factor(month.name, ordered = TRUE, levels = month.name)
  )

bikes = 
  crash_dat %>%
  filter_for("bike") %>%
  filter(
    month %in% (3:10),
    number_of_cyclist_injured > 0
    ) %>%
  separate(crash_time, into = c("hour", "minute", "second"), sep = ":") %>%
  mutate(
    covid = as.factor(if_else(year < 2020, 'Pre-COVID', 'COVID')),
    vehicle_number = str_extract_all(vehicle_number, "\\d", simplify = TRUE),
    covid = fct_relevel(covid, 'Pre-COVID'),
    dow = fct_relevel(dow, "Sunday", "Saturday", "Friday", "Thursday", "Wednesday", "Tuesday")
  ) 

microveh = 
  crash_dat %>%
  filter_for("micro") %>%
  filter(
    month %in% (3:10),
    number_of_persons_injured > 0
    ) %>%
  separate(crash_time, into = c("hour", "minute", "second"), sep = ":") %>%
  mutate(
    covid = as.factor(if_else(year < 2020, 'Pre-COVID', 'COVID')),
    vehicle_number = str_extract_all(vehicle_number, "\\d", simplify = TRUE),
    covid = fct_relevel(covid, 'Pre-COVID'),
    dow = fct_relevel(dow, "Sunday", "Saturday", "Friday", "Thursday", "Wednesday", "Tuesday")
  ) 


```


Interactive Maps
=======================================================================

Column {.tabset data-width=400}
-----------------------------------------------------------------------

###

```{r, echo = FALSE}

microvehicles = 
  crash_dat %>% 
  drop_na(c(latitude, longitude, borough)) %>% 
  filter(
    year > 2018,
    latitude > 0) %>%  
  filter(str_detect(vehicle_options, "[Bb]ike") | 
           str_detect(vehicle_options, "REVEL") | 
           str_detect(vehicle_options, "SCO")  |
           str_detect(vehicle_options, "MOP")   |
           str_detect(vehicle_options, "ELEC")  |
           str_detect(vehicle_options, "^E-")) %>% 
  filter(vehicle_options != "ESCOVATOR")

#rmarkdown::render("dashboard.Rmd", output_format = "flexdashboard::flex_dashboard")
map_cyclists_injured =  
  microvehicles %>% 
  filter(
    number_of_cyclist_injured > 0) %>%
  mutate(
    covid = as.factor(if_else(year == 2019, 'Pre-COVID', 'COVID')),
    text_label = str_c("Number Injured: ", number_of_cyclist_injured)) %>% 
  plot_mapbox(
    lon = ~longitude, 
    lat = ~latitude, 
    split = ~year, 
    size = ~number_of_cyclist_injured,
    color = ~borough,
    mode = 'markers',
    text = ~text_label) %>% 
  layout(
    mapbox = 
      list(
        style = 'dark',
        zoom = 9.5, 
        center = list(lat = 40.71, lon = -73.97)),
    title = "Crashes with Cyclists Injured in New York City 2019 - 
    2020",
    width = 900)

map_cyclists_injured %>% config(mapboxAccessToken = Sys.getenv("MAPBOX_TOKEN"))
```



### Density of Bicycle Crashes with Cyclists Injured During Covid

```{r, echo=FALSE}
 crash_dat %>%  
  filter_for("bike") %>% 
  drop_na(c(latitude, longitude, borough)) %>% 
  filter(number_of_cyclist_injured > 0) %>% 
  mutate(
    covid = as.factor(if_else(year == 2019, 'Pre-COVID', 'COVID')),
    text_label = str_c("Time Period: ", covid))  %>% 
  filter(
    covid == "COVID"
  ) %>% 
  plot_ly(
    lon = ~longitude, 
    lat = ~latitude,  
    type = 'densitymapbox',
    radius = 3,
    text = ~covid,
    hoverinfo = 'text') %>% 
  layout(
    mapbox = 
      list(
        style = 'open-street-map',
        zoom = 9.5,
        center = list(lat = 40.71, lon = -73.97)),
      title = "Density of Bicycle Crashes \n During Covid in NYC")


```


### Density of Bicycle Crashes with Cyclists Injured Prior to Covid

```{r, echo=FALSE}
crash_dat %>%  
  filter_for("bike") %>% 
  drop_na(c(latitude, longitude, borough)) %>% 
  filter(number_of_cyclist_injured > 0) %>% 
  mutate(
    covid = as.factor(if_else(year == 2019, 'Pre-COVID', 'COVID')),
    text_label = str_c("Time Period: ", covid))  %>% 
  filter(covid == "Pre-COVID") %>% 
  plot_ly(
    lon = ~longitude, 
    lat = ~latitude,  
    type = 'densitymapbox',
    radius = 3,
    text = ~covid,
    hoverinfo = 'text') %>% 
  layout(
    mapbox = 
      list(
        style = 'open-street-map',
        zoom = 10.5,
        center = list(lat = 40.71, lon = -73.97)),
      title = "Density of Bicycle Crashes \n Prior to Covid in NYC")

#let's fix the titles here


```


Contributing Factors
=======================================================================


Column {.tabset .tabset-fade}
-------------------------------------
    
### Contributing Factors Bikes
```{r contributing_factor_bike, echo = FALSE, message = FALSE, warning = FALSE, fig.width=8}

top_10_bike = crash_dat %>%
  filter_for("bike") %>%
  filter(
    month %in% (3:10),
    number_of_cyclist_injured > 0
    ) %>%
  separate(crash_time, into = c("hour", "minute", "second"), sep = ":") %>%
  mutate(
    covid = as.factor(if_else(year < 2020, 'Pre-COVID', 'COVID')),
    vehicle_number = str_extract_all(vehicle_number, "\\d", simplify = TRUE),
    covid = fct_relevel(covid, 'Pre-COVID'),
    dow = fct_relevel(dow, "Sunday", "Saturday", "Friday", "Thursday", "Wednesday", "Tuesday")
  ) %>% 
  pivot_longer(
    contributing_factor_vehicle_1:contributing_factor_vehicle_5,
    names_to = "vehicle_factor_num",
    names_prefix = "contributing_factor_vehicle_",
    values_to = "contributing_factor"
   ) %>%
  mutate(
    contributing_factor = if_else(contributing_factor == "Pedestrian/Bicyclist/Other Pedestrian Error/Confusion", "Pedestrian/Cyclist Error", contributing_factor)
  ) %>%
  group_by(covid, contributing_factor) %>%
  summarise(
    collisions = n_distinct(collision_id)
  ) %>%
  drop_na(contributing_factor) %>%
  ungroup(contributing_factor) %>%
  filter(contributing_factor != "Unspecified") %>%
  mutate(
    covid = fct_relevel(covid, 'Pre-COVID'),
    proportion = round(collisions / sum(collisions), 2) 
  ) %>%
  group_by(covid) %>%
  top_n(n = 10, wt = proportion) %>%
  mutate(
    contributing_factor = fct_reorder(as.factor(contributing_factor), collisions, .desc = TRUE)
  ) %>%
  ggplot(aes(x = contributing_factor, y = proportion, fill = covid)) +
  geom_bar(stat = "identity") +
  facet_grid( . ~covid, scales = "free_x", space = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), legend.position = "none") +
  labs(
    title = "Top Ten Contributing Factors for Crashes Involving Injuries to Cyclists",
    x = "",
    y = ""
  ) 


ggplotly(top_10_bike, tooltip = c("x", "y")) 
```


### Contributing Factors Microvehicle
    
```{r contributing_factor_micro, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 8}
top_10_micro = microveh %>%
  pivot_longer(
    contributing_factor_vehicle_1:contributing_factor_vehicle_5,
    names_to = "vehicle_factor_num",
    names_prefix = "contributing_factor_vehicle_",
    values_to = "contributing_factor"
   ) %>%
  mutate(
    contributing_factor = if_else(contributing_factor == "Pedestrian/Bicyclist/Other Pedestrian Error/Confusion", "Pedestrian/Cyclist Error", contributing_factor)
  ) %>%
  group_by(covid, contributing_factor) %>%
  summarise(
    collisions = n_distinct(collision_id)
  ) %>%
  drop_na(contributing_factor) %>%
  ungroup(contributing_factor) %>%
  filter(contributing_factor != "Unspecified") %>%
  mutate(
    covid = fct_relevel(covid, 'Pre-COVID'),
    proportion = round(collisions / sum(collisions), 2) 
  ) %>%
  group_by(covid) %>%
  top_n(n = 10, wt = proportion) %>%
  mutate(
    contributing_factor = fct_reorder(as.factor(contributing_factor), collisions, .desc = TRUE)
  ) %>%
  ggplot(aes(x = contributing_factor, y = proportion, fill = covid)) +
  geom_bar(stat = "identity") +
  facet_grid( . ~covid, scales = "free_x", space = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), legend.position = "none") +
  labs(
    title = "Top Ten Contributing Factors for Microvehicle Crashes Involving Injuries",
    x = "",
    y = ""
  )

ggplotly(top_10_micro, tooltip = c("x", "y")) 
```
 
 
